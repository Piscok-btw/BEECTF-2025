# --- builder: only what's needed to compile ---
FROM ubuntu:24.04 AS build
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      gcc libc6-dev && \
    rm -rf /var/lib/apt/lists/*
WORKDIR /src
COPY ./baratie.c .
# Your desired insecure flags for the challenge:
RUN gcc -O0 -fno-stack-protector -no-pie -D_FORTIFY_SOURCE=0 -o baratie baratie.c && \
    strip -s baratie || true

# --- runtime: no compiler, just whatâ€™s needed to run ---
FROM ubuntu:24.04

# Create unprivileged user/group
RUN useradd -U -m -s /bin/bash support
WORKDIR /home/support

# Copy runtime artifacts
COPY --from=build /src/baratie /home/support/baratie
COPY ./flag.txt /home/support/flag.txt
COPY ./ynetd /usr/bin/ynetd

# Lock down permissions (flag only root-readable)
RUN chown root:root /home/support/flag.txt && chmod 400 /home/support/flag.txt && \
    chown -R root:support /home/support && chmod -R 750 /home/support && \
    chown root:support /usr/bin/ynetd && chmod 750 /usr/bin/ynetd

USER support
EXPOSE 13375
CMD ["/usr/bin/ynetd", "-p", "13375", "/home/support/baratie"]

